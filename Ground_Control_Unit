#include <SPI.h>
#include <LoRa.h>

#define ss 5
#define rst 14
#define dio0 2
#define BAND 433E6  // Adjust the frequency band as needed
int counter = 0;
unsigned long previousMillis = 0;
const long interval = 200;  // Blink interval in milliseconds

void setup() {
  Serial.begin(9600);
  startLoRa();
  pinMode(33, OUTPUT);
  pinMode(25, OUTPUT);

  Serial.println("LoRa, GPS, and LED Initialization OK!");
}

void startLoRa() {
  LoRa.setPins(ss, rst, dio0);
  while (!LoRa.begin(BAND) && counter < 10) {
    Serial.print(".");
    counter++;
    delay(500);
  }
  if (counter == 10) {
    Serial.println("Starting LoRa failed!");
  } else {
    Serial.println("LoRa Initialization OK!");
  }
  delay(800);
}

void receivedData() {
  int packetSize = LoRa.parsePacket();
  if (packetSize) {
    String receivedMessage = "";
    while (LoRa.available()) {
      receivedMessage += (char)LoRa.read();
    }
    Serial.println("Received Data: " + receivedMessage);

    if (receivedMessage.indexOf("UP22XY0001,") != -1) {
      blinkLED(33);
    } else if (receivedMessage.indexOf("UP22XY0002,") != -1) {
      blinkLED(25);
    }
    return;
  }
}

void blinkLED(int pin) {
  unsigned long currentMillis = millis();

  if (currentMillis - previousMillis >= interval) {
    previousMillis = currentMillis;

    if (digitalRead(pin) == LOW) {
      digitalWrite(pin, HIGH);
    } else {
      digitalWrite(pin, LOW);
    }
  }
}

void ReadSerialData() {
  {
    if (Serial.available() > 0) {
      String command = Serial.readString();
      sendData(command);
    }
  }
}

void sendData(String message) {
  LoRa.beginPacket();
  LoRa.print(message);
  LoRa.endPacket();
}

void loop() {
  receivedData();
  ReadSerialData();
}
